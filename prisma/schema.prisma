generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DbUserRole {
  guest
  tourist
  verified_tourist
  partner
  partner_manager
  city_moderator
  country_moderator
  platform_admin
  super_admin

  @@map("users_role_enum")
}

enum DbVerificationStatus {
  unverified
  email_verified
  phone_verified
  identity_verified
  business_verified

  @@map("users_verificationstatus_enum")
}

enum DbPartnerManagerRoleType {
  manager
  analyst
  manager_analyst

  @@map("users_managerroletype_enum")
}

model User {
  id                 String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt          DateTime               @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime               @updatedAt @default(now()) @db.Timestamptz(6)
  deletedAt          DateTime?              @db.Timestamptz(6)

  email              String?                @unique @db.Text
  phone              String?                @unique @db.Text
  passwordHash       String                 @db.Text
  refreshTokenHash   String?                @db.Text

  role               DbUserRole               @default(tourist)
  verificationStatus DbVerificationStatus     @default(unverified)
  isActive           Boolean                @default(true)
  isSuspended        Boolean                @default(false)
  suspendedUntil     DateTime?              @db.Timestamptz(6)

  cityAssignments    Json                   @default("[]")
  countryAssignments Json                   @default("[]")
  partnerId          String?                @db.Uuid
  managerRoleType    DbPartnerManagerRoleType?

  selectedCityId     String?                @db.Uuid
  selectedCity       City?                  @relation("UserSelectedCity", fields: [selectedCityId], references: [id], onDelete: SetNull)

  @@index([selectedCityId])
  @@map("users")
}

model Country {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @default(now()) @db.Timestamptz(6)
  deletedAt DateTime? @db.Timestamptz(6)

  name      String   @db.Text
  isoCode2  String   @unique @db.VarChar(2)
  isoCode3  String?  @unique @db.VarChar(3)

  cities    City[]

  @@map("countries")
}

model City {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @default(now()) @db.Timestamptz(6)
  deletedAt DateTime? @db.Timestamptz(6)

  name      String   @db.Text
  countryId String   @db.Uuid
  country   Country  @relation(fields: [countryId], references: [id], onDelete: Restrict)

  // PostGIS-ready column for geo queries. Prisma treats it as unsupported; geo queries use raw SQL in later steps.
  location  Unsupported("geography(Point,4326)")?

  heroImageUrl String? @db.Text

  places    Place[]
  selectedByUsers User[] @relation("UserSelectedCity")

  @@index([countryId])
  @@map("cities")
}

model Category {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @default(now()) @db.Timestamptz(6)
  deletedAt DateTime? @db.Timestamptz(6)

  name      String    @db.Text
  slug      String    @unique @db.Text

  places    Place[]

  @@map("categories")
}

model Place {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt   DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime   @updatedAt @default(now()) @db.Timestamptz(6)
  deletedAt   DateTime?  @db.Timestamptz(6)

  name        String     @db.Text
  description String?    @db.Text
  isPublished Boolean    @default(false)

  cityId      String     @db.Uuid
  city        City       @relation(fields: [cityId], references: [id], onDelete: Restrict)

  categoryId  String?    @db.Uuid
  category    Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  media       PlaceMedia[]

  @@index([cityId])
  @@index([categoryId])
  @@index([isPublished])
  @@map("places")
}

model PlaceMedia {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @default(now()) @db.Timestamptz(6)
  deletedAt DateTime? @db.Timestamptz(6)

  placeId   String    @db.Uuid
  place     Place     @relation(fields: [placeId], references: [id], onDelete: Cascade)

  url       String    @db.Text
  sortOrder Int       @default(0)

  @@index([placeId])
  @@map("place_media")
}


